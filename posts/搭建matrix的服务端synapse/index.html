<!doctype html><html lang=zh-CN dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>搭建Matrix的服务端Synapse &#183; 容器</title><meta name=title content="搭建Matrix的服务端Synapse &#183; 容器"><meta name=keywords content="Matrix,Synapse,PostgreSQL,"><link rel=canonical href=https://b.myvessel.top/posts/%E6%90%AD%E5%BB%BAmatrix%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AFsynapse/><link type=text/css rel=stylesheet href=/css/main.bundle.min.14ca0fd95a3c15c960e83b49e9cb79f552ed206508f069f44b5401064bec1d9e1828e9e497c282d39b13a7a759a9bf9766a14689723deab3d2f8fe8cea393bd4.css integrity="sha512-FMoP2Vo8Fclg6DtJ6ct59VLtIGUI8Gn0S1QBBkvsHZ4YKOnkl8KC05sTp6dZqb+XZqFGiXI96rPS+P6M6jk71A=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.3ddcf04f5b0d4c32f72e726d3c12eebccd8c3c9f9daa9a13414808895de0ae1e1cdddda6849680d5bd96dbb60d0b1e0b24c29f5c83e5631e55e7e6bc02015490.js integrity="sha512-PdzwT1sNTDL3LnJtPBLuvM2MPJ+dqpoTQUgIiV3grh4c3d2mhJaA1b2W27YNCx4LJMKfXIPlYx5V5+a8AgFUkA==" data-copy data-copied></script>
<script src=/js/zoom.min.js></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="搭建Matrix的服务端Synapse"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://b.myvessel.top/posts/%E6%90%AD%E5%BB%BAmatrix%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AFsynapse/"><meta property="og:image" content="https://b.myvessel.top/posts/%E6%90%AD%E5%BB%BAmatrix%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AFsynapse/feature.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-28T14:37:56+08:00"><meta property="article:modified_time" content="2023-04-28T14:37:56+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://b.myvessel.top/posts/%E6%90%AD%E5%BB%BAmatrix%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AFsynapse/feature.jpg"><meta name=twitter:title content="搭建Matrix的服务端Synapse"><meta name=twitter:description content><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"搭建Matrix的服务端Synapse","headline":"搭建Matrix的服务端Synapse","inLanguage":"zh-cn","url":"https:\/\/b.myvessel.top\/posts\/%E6%90%AD%E5%BB%BAmatrix%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AFsynapse\/","author":{"@type":"Person","name":"Vessel"},"copyrightYear":"2023","dateCreated":"2023-04-28T14:37:56\u002b08:00","datePublished":"2023-04-28T14:37:56\u002b08:00","dateModified":"2023-04-28T14:37:56\u002b08:00","keywords":["Matrix","Synapse","PostgreSQL"],"mainEntityOfPage":"true","wordCount":"4297"}]</script><meta name=author content="Vessel"><link href=mailto:w1572651092@gmail.com rel=me><link href=https://github.com/0Vessel0 rel=me><link href=https://acg.mn/@w1572651092 rel=me><link href=https://t.me/vesselvessel rel=me><script src=/lib/jquery/jquery.slim.min.js integrity></script><meta name=theme-color><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js></script>
<script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js></script>
<script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js></script>
<script>const firebaseConfig={apiKey:"AIzaSyBhCLxCAZAsZyOY5Jfx3GQpXY8-WKsgMAY",authDomain:"AIzaSyBhCLxCAZAsZyOY5Jfx3GQpXY8-WKsgMAY",projectId:"hugo-vessel",storageBucket:"hugo-vessel.appspot.com",messagingSenderId:"296824508371",appId:"1:296824508371:web:215570749ab6d460832926",measurementId:"G-8MFDNYY6J5"};var app=firebase.initializeApp(firebaseConfig),db=firebase.firestore(),auth=firebase.auth()</script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span></a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px]" style=z-index:100><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">容器</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href=/posts/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 32H480c17.7.0 32 14.3 32 32V96c0 17.7-14.3 32-32 32H32C14.3 128 0 113.7.0 96V64C0 46.3 14.3 32 32 32zm0 128H480V416c0 35.3-28.7 64-64 64H96c-35.3.0-64-28.7-64-64V160zm128 80c0 8.8 7.2 16 16 16H336c8.8.0 16-7.2 16-16s-7.2-16-16-16H176c-8.8.0-16 7.2-16 16z"/></svg></span></span><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=Posts>归档</p></a><div><div class="cursor-pointer flex items-center nested-menu"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M0 80C0 53.5 21.5 32 48 32h96c26.5.0 48 21.5 48 48V96H384V80c0-26.5 21.5-48 48-48h96c26.5.0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H432c-26.5.0-48-21.5-48-48V160H192v16c0 1.7-.1 3.4-.3 5L272 288h96c26.5.0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H272c-26.5.0-48-21.5-48-48V336c0-1.7.1-3.4.3-5L144 224H48c-26.5.0-48-21.5-48-48V80z"/></svg></span></span><a class="text-base font-medium text-gray-500 hover:text-gray-900" title>清单</a>
<span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/categories/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M0 96C0 78.3 14.3 64 32 64H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7.0 96zM64 256c0-17.7 14.3-32 32-32H480c17.7.0 32 14.3 32 32s-14.3 32-32 32H96c-17.7.0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7.0-32-14.3-32-32s14.3-32 32-32H416c17.7.0 32 14.3 32 32z"/></svg></span></span><p class="text-sm font-sm text-gray-500 hover:text-gray-900" title=Categories>分类</p></a><a href=/tags/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M345 39.1 472.8 168.4c52.4 53 52.4 138.2.0 191.2l-112 113.3c-9.3 9.4-24.5 9.5-33.9.2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4.0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6.2-33.9s24.6-9.2 33.9.2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5.0 90.5L277.3 442.7c-25 25-65.5 25-90.5.0l-168-168C6.7 262.7.0 246.5.0 229.5zM144 144a32 32 0 10-64 0 32 32 0 1064 0z"/></svg></span></span><p class="text-sm font-sm text-gray-500 hover:text-gray-900" title=Tags>标签</p></a></div></div></div></div><a href=/links/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=友链>友链</p></a><a href=/journal/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M408 120c0 54.6-73.1 151.9-105.2 192-7.7 9.6-22 9.6-29.6.0C241.1 271.9 168 174.6 168 120 168 53.7 221.7.0 288 0s120 53.7 120 120zm8 80.4c3.5-6.9 6.7-13.8 9.6-20.6.5-1.2 1-2.5 1.5-3.7l116-46.4C558.9 123.4 576 135 576 152V422.8c0 9.8-6 18.6-15.1 22.3L416 503V200.4zM137.6 138.3c2.4 14.1 7.2 28.3 12.8 41.5 2.9 6.8 6.1 13.7 9.6 20.6V451.8L32.9 502.7C17.1 509 0 497.4.0 480.4V209.6c0-9.8 6-18.6 15.1-22.3l122.6-49zM327.8 332c13.9-17.4 35.7-45.7 56.2-77V504.3L192 449.4V255c20.5 31.3 42.3 59.6 56.2 77 20.5 25.6 59.1 25.6 79.6.0zM288 152a40 40 0 100-80 40 40 0 100 80z"/></svg></span></span><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=日志>日志</p></a><a href=/about/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg></span></span><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=关于>关于</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400 h-12" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher aria-label="Dark mode switcher" type=button><div class="flex items-center justify-center h-12 dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden h-12 dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button style=margin-right:5px><div class="flex items-center justify-center h-12 dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden h-12 dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/posts/ class="flex items-center"><div class=mr-2><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 32H480c17.7.0 32 14.3 32 32V96c0 17.7-14.3 32-32 32H32C14.3 128 0 113.7.0 96V64C0 46.3 14.3 32 32 32zm0 128H480V416c0 35.3-28.7 64-64 64H96c-35.3.0-64-28.7-64-64V160zm128 80c0 8.8 7.2 16 16 16H336c8.8.0 16-7.2 16-16s-7.2-16-16-16H176c-8.8.0-16 7.2-16 16z"/></svg></span></div><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=Posts>归档</p></a></li><li class=mt-1><a class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M0 80C0 53.5 21.5 32 48 32h96c26.5.0 48 21.5 48 48V96H384V80c0-26.5 21.5-48 48-48h96c26.5.0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H432c-26.5.0-48-21.5-48-48V160H192v16c0 1.7-.1 3.4-.3 5L272 288h96c26.5.0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H272c-26.5.0-48-21.5-48-48V336c0-1.7.1-3.4.3-5L144 224H48c-26.5.0-48-21.5-48-48V80z"/></svg></span></span><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title>清单</p><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></a></li><li class=mt-1><a href=/categories/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M0 96C0 78.3 14.3 64 32 64H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7.0 96zM64 256c0-17.7 14.3-32 32-32H480c17.7.0 32 14.3 32 32s-14.3 32-32 32H96c-17.7.0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7.0-32-14.3-32-32s14.3-32 32-32H416c17.7.0 32 14.3 32 32z"/></svg></span></span><p class="text-sm font-small text-gray-500 hover:text-gray-900" title=Categories>分类</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M345 39.1 472.8 168.4c52.4 53 52.4 138.2.0 191.2l-112 113.3c-9.3 9.4-24.5 9.5-33.9.2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4.0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6.2-33.9s24.6-9.2 33.9.2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5.0 90.5L277.3 442.7c-25 25-65.5 25-90.5.0l-168-168C6.7 262.7.0 246.5.0 229.5zM144 144a32 32 0 10-64 0 32 32 0 1064 0z"/></svg></span></span><p class="text-sm font-small text-gray-500 hover:text-gray-900" title=Tags>标签</p></a></li><li class=mb-2></li><li class=mt-1><a href=/links/ class="flex items-center"><div class=mr-2><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></div><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=友链>友链</p></a></li><li class=mt-1><a href=/journal/ class="flex items-center"><div class=mr-2><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M408 120c0 54.6-73.1 151.9-105.2 192-7.7 9.6-22 9.6-29.6.0C241.1 271.9 168 174.6 168 120 168 53.7 221.7.0 288 0s120 53.7 120 120zm8 80.4c3.5-6.9 6.7-13.8 9.6-20.6.5-1.2 1-2.5 1.5-3.7l116-46.4C558.9 123.4 576 135 576 152V422.8c0 9.8-6 18.6-15.1 22.3L416 503V200.4zM137.6 138.3c2.4 14.1 7.2 28.3 12.8 41.5 2.9 6.8 6.1 13.7 9.6 20.6V451.8L32.9 502.7C17.1 509 0 497.4.0 480.4V209.6c0-9.8 6-18.6 15.1-22.3l122.6-49zM327.8 332c13.9-17.4 35.7-45.7 56.2-77V504.3L192 449.4V255c20.5 31.3 42.3 59.6 56.2 77 20.5 25.6 59.1 25.6 79.6.0zM288 152a40 40 0 100-80 40 40 0 100 80z"/></svg></span></div><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=日志>日志</p></a></li><li class=mt-1><a href=/about/ class="flex items-center"><div class=mr-2><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg></span></div><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=关于>关于</p></a></li></ul></div></label></div></div><script>(function(){var e=$(".main-menu"),t=window.location.pathname;e.find('a[href="'+t+'"]').each(function(e,t){$(t).children("p").addClass("active")})})()</script></div></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("menu-blur");n.style.opacity=t/300})</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style="background-image:url(https://lp.ena.sh/r?uid=vessel&albumid=9&ttl=%5b94%5d)"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">搭建Matrix的服务端Synapse</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2023-04-28 14:37:56 +0800 +0800">2023年 4月 28日</time><span class="px-2 text-primary-500">&#183;</span><span>4297 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>9 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_posts/搭建Matrix的服务端Synapse/index.md title=views>0</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_posts/搭建Matrix的服务端Synapse/index.md title=likes>0</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<button id=likes_button class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400" onclick=process_article()>
<span id=likes_button_heart style=display:none class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span><span id=likes_button_emtpty_heart class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M244 84l11.1 12 12-11.98C300.6 51.37 347 36.51 392.6 44.1 461.5 55.58 512 115.2 512 185.1V190.9c0 41.5-17.2 81.2-47.6 109.5L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9S235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1.0 232.4.0 190.9V185.1c0-69.9 50.52-129.52 119.4-141 44.7-7.59 92 7.27 124.6 39.9C243.1 84 244 84.01 244 84zm11.1 79.9-45-46.8c-21.7-20.82-52.5-30.7-82.8-25.66C81.55 99.07 48 138.7 48 185.1V190.9c0 28.2 11.71 55.2 32.34 74.4L256 429.3l175.7-164c20.6-19.2 32.3-46.2 32.3-74.4V185.1c0-46.4-33.6-86.03-79.3-93.66C354.4 86.4 323.6 96.28 301.9 117.1l-46.8 46.8z"/></svg></span></span><span id=likes_button_text>&nbsp;Like</span></button></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/%E6%9C%89%E8%B6%A3%E7%9A%84%E4%B8%9C%E8%A5%BF/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">有趣的东西</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/matrix/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Matrix</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/synapse/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Synapse</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/postgresql/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">PostgreSQL</span></span></span></div></div><div class=flex><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt=Vessel src=/img/logo_huc30493f834270db7695c249eed3e0602_388971_192x192_fill_box_center_3.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Vessel</div><div class="text-sm text-neutral-700 dark:text-neutral-400">这是没有办法的事，为了追求进一步的幸福，痛苦是必要的</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:w1572651092@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/0Vessel0 target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://acg.mn/@w1572651092 target=_blank aria-label=Mastodon rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://t.me/vesselvessel target=_blank aria-label=Telegram rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first sm:max-w-prose lg:ml-auto px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden"></summary><div class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#环境>环境</a></li><li><a href=#安装>安装</a><ul><li><a href=#postgresql-的安装>PostgreSQL 的安装</a></li><li><a href=#postgresql-的配置>PostgreSQL 的配置</a></li><li><a href=#synapse-的安装>Synapse 的安装</a></li><li><a href=#synapse-的配置>Synapse 的配置</a></li></ul></li><li><a href=#配置外部访问>配置外部访问</a></li><li><a href=#后记>后记</a></li><li><a href=#参考文章>参考文章</a></li></ul></nav></div></details><details class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden"></summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#环境>环境</a></li><li><a href=#安装>安装</a><ul><li><a href=#postgresql-的安装>PostgreSQL 的安装</a></li><li><a href=#postgresql-的配置>PostgreSQL 的配置</a></li><li><a href=#synapse-的安装>Synapse 的安装</a></li><li><a href=#synapse-的配置>Synapse 的配置</a></li></ul></li><li><a href=#配置外部访问>配置外部访问</a></li><li><a href=#后记>后记</a></li><li><a href=#参考文章>参考文章</a></li></ul></nav></div></details><script>(function(){var t,e=$("#TableOfContents");if(e.length>0){t=$(window);function n(){var s,o=t.scrollTop(),i=$(".anchor"),n="";if(i.each(function(e,t){t=$(t),t.offset().top-$(window).height()/3<=o&&(n=t.attr("id"))}),s=e.find("a.active"),s.length==1&&s.eq(0).attr("href")=="#"+n)return!0;s.each(function(e,t){$(t).removeClass("active").siblings("ul").hide()}),e.find('a[href="#'+n+'"]').addClass("active"),e.find('a[href="#'+n+'"]').parentsUntil("#TableOfContents").each(function(e,t){$(t).children("a").parents("ul").show()})}t.on("scroll",n),$(document).ready(function(){e.find("a").parent("li").find("ul").hide(),n()})}})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="max-w-prose mb-20"><div id=前言 class=anchor></div><h2 class="relative group">前言
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%89%8d%e8%a8%80 aria-label=锚点>#</a></span></h2><p>被<a href=https://naine.cc target=_blank>
naine</a> 要求当工具人，搭建 Matrix 服务器试试效果。Matrix 是一个去中心化，开源的实时通信服务框架，详情请谷歌<del>其实能找到这篇文章的人完全不需要这些解释吧</del>。</p><p>首先选择搭建哪一种服务端，就我没有特意去查，即便如此也看到的服务端有三种，分别是：</p><ol><li>Synapse：Matrix 开发团队用 Python 写的第一代服务端，稳定但庞大，对服务器性能要求高，部署麻烦。</li><li>Dendrite：Matrix 开发团队用 Go 写的第二代服务端，性能表现更好（也就是对服务器性能要求没那么高）。</li><li>Conduit：第三方开发的用 Rust🦀 写的服务端。切中以上两者痛点，面向小型服务器，主打部署便捷，能快速运行起来而不需要去啃官方又臭又长的文档。</li></ol><p>我的需求是不到 5 个人的超小聊天室，按照以上的特性归纳，我毫无疑问应该选择 Conduit …… 本来应该是这样的，但看到本文标题就应该明白最后选择的还是 Synapse。原因是<a href=https://naine.cc target=_blank>
naine</a> 要求用 Synapse 来搭建。工具人没有话语权，所以我们放弃看起来很方便的 Conduit，来搭建庞大的 Synapse。在搜介绍的时候看到有人说 Synapse 作为第一代官方服务端，用的人最多，所以网上各种教程也最多。但我在网上查到的中文搭建教程非常少，一共才三四篇<del>可能外文教程比较多吧</del>。总之过程中踩了不少坑，所以来记录一下工具人生活，也希望能让同样需求的人少踩点坑。</p><div id=环境 class=anchor></div><h2 class="relative group">环境
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%8e%af%e5%a2%83 aria-label=锚点>#</a></span></h2><p>我的环境是嫖自谷歌云的 4h4g 的 Debian 11。Synapse 需要的具体配置我没有调查，但是作为实时聊天服务器，性能还是尽量往高走。正好 4h4g 只搭个博客也太浪费了，搭 Synapse 也算是充分利用性能了。</p><div id=安装 class=anchor></div><h2 class="relative group">安装
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%89%e8%a3%85 aria-label=锚点>#</a></span></h2><p>下面开始正式搭建过程。</p><div class="flex px-4 py-3 rounded-md" style=background-color:#e63946><span class="ltr:pr-3 rtl:pl-3 flex items-center" style=color:#1d3557><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg></span></span><span style=color:#f1faee>本文所有命令如无特别说明，请以 root 用户身份运行。</span></div><div id=postgresql-的安装 class=anchor></div><h3 class="relative group">PostgreSQL 的安装
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#postgresql-%e7%9a%84%e5%ae%89%e8%a3%85 aria-label=锚点>#</a></span></h3><p>官方并没有对数据库类型做出要求，默认使用 sqlite3 作为数据库。但 sqlite3 虽然方便，性能却极其拉跨。所以选择使用官方推荐的 PostgreSQL 作为数据库。</p><p>安装过程也很简便。首先更新一下软件包列表然后安装 PostgreSQL：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt install postgresql
</span></span></code></pre></div><p>即可。重点是接下来的配置。</p><div id=postgresql-的配置 class=anchor></div><h3 class="relative group">PostgreSQL 的配置
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#postgresql-%e7%9a%84%e9%85%8d%e7%bd%ae aria-label=锚点>#</a></span></h3><p>先来做好数据库的配置，这样配置 synapse 的过程会比较流畅。</p><p>首先是一些新安装后的初始工作。刚安装好 PostgreSQL 时会自动新创建一个数据库用户和一个 Linux 系统用户，用户名都是 postgres，用以作为超级管理员管理数据库。所以先更改一下这两个用户的密码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>su postgres <span class=c1>#以postgres用户登录Linux系统</span>
</span></span><span class=line><span class=cl>psql <span class=c1>#进入数据库</span>
</span></span></code></pre></div><p>然后命令行前面的提示符会变成 <code>postgres=#</code>。接下来通过以下将数据库用户 postgres 的密码更改为 <code>example</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ALTER USER postgres WITH PASSWORD <span class=s1>&#39;example&#39;</span><span class=p>;</span>
</span></span></code></pre></div><p><strong>注意在数据库内</strong><code>;</code><strong>才代表这句命令完全结束了</strong>。若未完全结束，前面的提示符会变成 <code>postgres-#</code>。所以记得加上 <code>;</code>。</p><p>然后使用 <code>\q</code> 退出数据库，然后使用 <code>exit</code> 退出 postgres 用户回到 root 用户。接着使用以下命令修改 Linux 系统用户 postgres 的密码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>passwd -d postgres <span class=c1>#清除postgres用户的初始密码</span>
</span></span><span class=line><span class=cl>su postgres <span class=c1>#重新进入postgres用户</span>
</span></span><span class=line><span class=cl>passwd <span class=c1>#修改postgres用户的密码</span>
</span></span></code></pre></div><p>接着说一下我的目标：直接用管理员用户使用数据库会比较危险。所以为了避免误操作，建立一个新数据库用户 <code>synapse_user</code> 并设置密码；并建立一个新数据库 <code>synapse</code> 供 Synapse 使用。</p><p>执行完上一部分命令后现在是 postgres 的系统用户身份。如果不小心退出了请使用 <code>su postgres</code> 回到此用户身份。</p><p>先执行以下命令创建数据库用户 <code>synapse_user</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>createuser --pwprompt synapse_user
</span></span></code></pre></div><p>其中 <code>--pwprompt</code> 表示建立该用户时设置密码，更详细的参数可参考 <a href=http://www.postgres.cn/docs/9.3/app-createuser.html target=_blank>createuser</a>。</p><p>然后进入数据库</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>psql
</span></span></code></pre></div><p>创建使用 UTF-8 编码，使用 ISO C 国际标准区域规则（即去除本地化，因为聊天服务器当然不止一个国家的人用<del>但我和朋友一起用好像也没必要啊</del>），使用数据库模板 <code>template0</code>（即纯净数据库，<code>template1</code> 为本地化后的数据库）的数据库 <code>synapse</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>CREATE DATABASE synapse
</span></span><span class=line><span class=cl>ENCODING <span class=s1>&#39;UTF8&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>LC_COLLATE</span><span class=o>=</span><span class=s1>&#39;C&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>LC_CTYPE</span><span class=o>=</span><span class=s1>&#39;C&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>template</span><span class=o>=</span>template0
</span></span><span class=line><span class=cl>OWNER synapse_user<span class=p>;</span>
</span></span></code></pre></div><p>关于 <code>LC_COLLATE</code> 和 <code>LC_CTYPE</code> 等详情，可查阅 <a href=http://www.postgres.cn/docs/10/locale.html target=_blank>23.1. 区域支持</a>。关于 <code>template0</code> 和 <code>template1</code>，可查阅 <a href=http://postgres.cn/docs/10/manage-ag-templatedbs.html target=_blank>22.3. 模板数据库</a>。</p><p>接着来到 <code>/etc/postgresql/&lt;pg_version>/main/</code> 下修改配置文件 <code>pg_hba.conf</code>，其中 <code>pg_version</code> 是你的 PostgreSQL 版本号。若没有找到该路径或文件请使用 <code>find / -name pg_hba.conf</code> 命令找到 <code>pg.hba.conf</code> 文件在哪。<code>pg_hba.conf</code> 用于配置客户端对数据库进行认证的详细参数。具体格式和内容可参考 <a href=http://www.postgres.cn/docs/9.4/auth-pg-hba-conf.html target=_blank>pg_hba.conf文件</a>。这里按照我的需求在文件末尾新开一行添加以下内容：</p><pre tabindex=0><code class=language-conf data-lang=conf>host    synapse     synapse_user    ::1/128     md5
</code></pre><p>每项参数含义如下：</p><ul><li>host：允许 TCP/IP 连接，不论是否使用 SSL。</li><li>synapse：只允许连接数据库 <code>synapse</code>。</li><li>synapse_user：只允许用户 <code>synapse_user</code> 连接此数据库。</li><li>::1/128：即 127.0.0.1/32。</li><li>md5：使用 md5 加密密码。<strong>若没有设置密码请将此项改为 trust</strong>。</li></ul><p>保存退出，至此，PostgreSQL 的配置就彻底完成了<del>什么？调参？不会！告辞！大佬请自行调参</del>。接下来终于可以开始正题 —— Synapse 的安装了。</p><div id=synapse-的安装 class=anchor></div><h3 class="relative group">Synapse 的安装
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#synapse-%e7%9a%84%e5%ae%89%e8%a3%85 aria-label=锚点>#</a></span></h3><p>Synapse 的安装也是非常的简单。首先安装依赖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt install -y lsb-release wget apt-transport-https
</span></span></code></pre></div><p>然后安装 Matrix 官方仓库 GPG 公钥，添加其官方源。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget -O /usr/share/keyrings/matrix-org-archive-keyring.gpg https://packages.matrix.org/debian/matrix-org-archive-keyring.gpg
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb [signed-by=/usr/share/keyrings/matrix-org-archive-keyring.gpg] https://packages.matrix.org/debian/ </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> main&#34;</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>tee /etc/apt/sources.list.d/matrix-org.list
</span></span></code></pre></div><p>然后更新软件列表并安装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt install matrix-synapse-py3
</span></span></code></pre></div><p>即可。安装过程会提示输入 server name：</p><p><figure><img class="my-0 rounded-md" srcset="/posts/%E6%90%AD%E5%BB%BAmatrix%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AFsynapse/install_hu65be6987adbd481e944f6d0c58c49de9_101630_330x0_resize_q75_box.jpg 330w,
/posts/%E6%90%AD%E5%BB%BAmatrix%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AFsynapse/install_hu65be6987adbd481e944f6d0c58c49de9_101630_660x0_resize_q75_box.jpg 660w,
/posts/%E6%90%AD%E5%BB%BAmatrix%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AFsynapse/install_hu65be6987adbd481e944f6d0c58c49de9_101630_1024x0_resize_q75_box.jpg 1024w,
/posts/%E6%90%AD%E5%BB%BAmatrix%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AFsynapse/install_hu65be6987adbd481e944f6d0c58c49de9_101630_1320x0_resize_q75_box.jpg 2x" src=/posts/%E6%90%AD%E5%BB%BAmatrix%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AFsynapse/install_hu65be6987adbd481e944f6d0c58c49de9_101630_660x0_resize_q75_box.jpg alt=install.jpg><figcaption>安装过程的server name</figcaption></figure></p><p>server name 是服务器的唯一标识，还会影响到在你的服务器上注册的用户的用户名。按我查到的教程来说，好像是可以随意填的，但根据我<strong>完全不严谨</strong>的探索，想完全正常使用并且方便配置的话最好填自己的域名。比如我这里填 myvessel.top 。Matrix 的 Delegation 功能使得 Synapse 可以和其他 server 共用同一个域名，所以不需要担心这个域名已经被别的 server 使用了。Server name 在 Synapse 正式初始化并启动运行之后就不能随意更改了，除非删除数据库重新开始<del>但这玩意安装好之后自动就启动了，真是 nt 逻辑</del>，也就是说不在这里填对就得删库，所以请慎重填写。</p><p>然后会问你是否发送匿名数据供他们统计，请按个人喜好选择。我选择拒绝😀。</p><p>看起来 server name 已经算坑了，但真正的大坑还在后头<del>这俩东西都是安装一时爽，配置火葬场</del>。</p><div id=synapse-的配置 class=anchor></div><h3 class="relative group">Synapse 的配置
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#synapse-%e7%9a%84%e9%85%8d%e7%bd%ae aria-label=锚点>#</a></span></h3><p>然后终于来到了本文重头戏，配置 Synapse，<strong>大坑</strong>。</p><p>配置 Synapse 主要是配置位于 <code>/etc/matrix-synapse/</code> 的 <code>homeserver.yaml</code> 文件。<strong>这里首先就有个坑</strong>，按我找到的几篇中文教程的语境，貌似安装好 Synapse 后会自动给一个非常详细的，很多注释项的 <code>homeserver.yaml</code>。但实际上我看到的 <code>homeserver.yaml</code> 是一个非常简陋的，并且不能投入使用的文件。有教程自行进行每一项的配置，但按我这个非常简陋的 <code>homeserver. yaml</code> ，每一项都需要去对着<a href=https://matrix-org.github.io/synapse/latest/usage/configuration/config_documentation.html target=_blank>
官方的配置手册</a> 自己添加，这也太麻烦了，而且官方文档写的也不是很出色，缺少实例，自己对着写出问题概率很高。但其实直接使用官方的生成配置文件功能即可解决这个问题。</p><p>首先来到 <code>/etc/matrix-synapse/</code> 下，把原本的 <code>homeserver.yaml</code> 删了，然后运行以下命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/opt/venvs/matrix-synapse/bin/python -B -m synapse.app.homeserver -c homeserver.yaml --generate-config --server-name<span class=o>=</span>example.com --report-stats<span class=o>=</span>no
</span></span></code></pre></div><p>其中 <code>example.com</code> 请替换为自己的 server name。</p><p>运行完成后当前目录就会多出几个文件，都是运行需要的文件，不用乱动。再打开新生成的 <code>homeserver.yaml</code>，这时就会发现多了几项内容，并且都已经填好了内容。有一篇教程使用自行生成的随机字符串作为 <code>registration_shared_secret</code> ，但其实直接使用这个生成功能，会自动把 <code>registration_shared_secret</code> 也生成了，就不必担心自己生成的字符串有问题了。</p><p>此时这个配置文件已经是可以投入正常使用的配置文件了，但我们还要修改一下，便于自己使用。</p><p>首先把 sqlite3 数据库更换为前面累死累活安装配置好的 PostgreSQL 数据库。</p><p>在内容中找到 sqlite3 相关的配置，然后注释掉或者删去。替换为以下内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>database</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>psycopg2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>synapse_user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>yourpassword</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>database</span><span class=p>:</span><span class=w> </span><span class=l>synapse</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cp_min</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cp_max</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>keepalives_idle</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>keepalives_interval</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>keepalives_count</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre></div><p>将以上内容根据自己实际情况填写。</p><p>另外注意 yaml 对缩进和空格要求非常严格，所以请确保自己对齐了。</p><p>以下是我的配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>server_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myvessel.top&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>pid_file</span><span class=p>:</span><span class=w> </span><span class=l>/etc/matrix-synapse/homeserver.pid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>listeners</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>  - port</span><span class=p>:</span><span class=w> </span><span class=m>8008</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>    tls</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>    type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>    x_forwarded</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>    bind_addresses</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;::1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;127.0.0.1&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>    resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>      - names</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>client, federation]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>        compress</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#database:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  name: sqlite3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  args:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    database: /etc/matrix-synapse/homeserver.db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>database</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>    name</span><span class=p>:</span><span class=w> </span><span class=l>psycopg2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>    args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>        user</span><span class=p>:</span><span class=w> </span><span class=l>synapse_user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>        password</span><span class=p>:</span><span class=w> </span><span class=l>yourpassword</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>        database</span><span class=p>:</span><span class=w> </span><span class=l>synapse</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>        host</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>        cp_min</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>        cp_max</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>        keepalives_idle</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>        keepalives_interval</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>        keepalives_count</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>log_config</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/matrix-synapse/myvessel.top.log.config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>media_store_path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/matrix-synapse/media_store</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>registration_shared_secret</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;example&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>report_stats</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>macaroon_secret_key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;example&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>form_secret</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;example&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>signing_key_path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/matrix-synapse/myvessel.top.signing.key&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>trusted_key_servers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>  - server_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;matrix.org&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>  - server_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;neo.angry.im&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>  - server_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;bgme.me&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>suppress_key_server_warning</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>enable_registration</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>enable_registration_without_verification</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>其中的敏感内容都用 &ldquo;example&rdquo; 进行了替代，替代前都是实际可用的值。</p><p><code>trusted_key_servers</code> 是现有的信任服务器，不能为空，默认为 <code>matrix.org</code>，可以加入自己认识的实例，我这里添加了 <code>neo.angry.im</code> 和 <code>bgme.me</code> <del>虽然并没有用上</del>。除此之外最后 3 行是我新配置的内容，效果分别如下：</p><ul><li><code>suppress_key_server_warning</code>：如果 <code>trusted_key_servers</code> 中有 <code>matrix.org</code>，此项须设为 <code>true</code>，否则启动时会有警告。</li><li><code>enable_registration</code>：设为 <code>true</code> 时允许注册。不能单独启用，下面必须设置注册验证方式或设为不验证即可注册。详情请查阅<a href=https://matrix-org.github.io/synapse/latest/usage/configuration/config_documentation.html#enable_registration target=_blank>
官方说明</a>。</li><li><code>enable_registration_without_verification</code>：设为 <code>true</code> 时允许不验证即可注册。</li></ul><p>配置好之后运行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl restart matrix-synapse
</span></span></code></pre></div><p>若无报错，即成功运行 Synapse。若有报错，请检查配置。</p><p>然后可运行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget http://localhost:8008
</span></span><span class=line><span class=cl>cat index.html
</span></span></code></pre></div><p>若有出现“Synapse is running”相关字眼，则说明成功运行了。</p><p>接下来给自己注册一个管理员账号，在终端里输入：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>register_new_matrix_user -c /etc/matrix-synapse/homeserver.yaml http://localhost:8008
</span></span></code></pre></div><p>然后在询问是否为管理员账户时输入 yes 即可。</p><p>在终端用以上方式进行注册是不受上文中 <code>enable_registration</code> 这一项的影响的，所以如果人数少并且用户不介意的话，可以直接在终端给全部用户都全部注册好，这样也就不需要开启注册了。</p><p>因为按我的需求，除了我之外只有几个人注册，所以我直接设为不验证注册了，注册完之后再把 <code>enable_registration</code> 和 <code>enable_registration_without_verification</code> 这两行删掉或者注释掉，然后再使用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl restart matrix-synapse
</span></span></code></pre></div><p>即可生效。<strong>每次修改了 <code>homeserver.yaml</code> 都需要运行上面的命令使新配置生效</strong>。</p><p>另外如果需要修改 server name，首先需要删除数据库重新创建，然后需要修改 <code>homeserver.yaml</code> 里的 <code>server_name</code>，以及 <code>/etc/matrix-synapse/conf.d/</code> 下的 <code>server_name.yaml</code> 里面的 <code>server_name</code> 这两个 <code>server_name</code> 需要保持一致。再用上面的命令 restart 即可。</p><div id=配置外部访问 class=anchor></div><h2 class="relative group">配置外部访问
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%85%8d%e7%bd%ae%e5%a4%96%e9%83%a8%e8%ae%bf%e9%97%ae aria-label=锚点>#</a></span></h2><p>为了让别人能用域名进行访问，需要设置反向代理，可参考<a href=https://matrix-org.github.io/synapse/latest/reverse_proxy.html target=_blank>
官方文档</a>。前文以及说过由于 Matrix 的 <a href=https://matrix-org.github.io/synapse/latest/delegate.html target=_blank>Delegation</a> 功能，使得 Synapse 可以和其他 server 共用同一个域名。而由于 server name 会影响你的账户名（形如@xxxx: example.com）。我觉得后面跟个老长的三级域名实在很不方便，所以选择直接用我的二级域名 <code>myvessel.top</code> 来作为 server name。</p><p>我使用的是 Caddy，原 Caddyfile 内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Caddyfile data-lang=Caddyfile><span class=line><span class=cl><span class=gh>www.myvessel.top</span> , <span class=gh>myvessel.top</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>encode</span> <span class=s>gzip</span> <span class=s>br</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>root</span> <span class=nd>*</span> <span class=s>/root/homepage</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>file_server</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>然后直接按照<a href=https://matrix-org.github.io/synapse/latest/reverse_proxy.html#caddy-v2 target=_blank>
官方文档</a>配置 Caddyfile 如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Caddyfile data-lang=Caddyfile><span class=line><span class=cl><span class=gh>www.myvessel.top</span> , <span class=gh>myvessel.top</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>encode</span> <span class=s>gzip</span> <span class=s>br</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>root</span> <span class=nd>*</span> <span class=s>/root/homepage</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>file_server</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> 
</span></span><span class=line><span class=cl><span class=s> </span> <span class=s> </span> <span class=s>header</span> <span class=nd>/.well-known/matrix/*</span> <span class=s>Content-Type</span> <span class=s>application/json</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>header</span> <span class=nd>/.well-known/matrix/*</span> <span class=s>Access-Control-Allow-Origin</span> <span class=s>*</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>respond</span> <span class=nd>/.well-known/matrix/server</span> <span class=s>`</span><span class=err>{</span><span class=s>&#34;m.server&#34;:</span> <span class=s>&#34;matrix.myvessel.top:443&#34;</span><span class=err>}</span><span class=s>`</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>respond</span> <span class=nd>/.well-known/matrix/client</span> <span class=s>`</span><span class=err>{</span><span class=s>&#34;m.homeserver&#34;:</span><span class=err>{</span><span class=s>&#34;base_url&#34;:&#34;https://matrix.myvessel.top&#34;</span><span class=err>}</span><span class=s>,&#34;m.identity_server&#34;:</span><span class=err>{</span><span class=s>&#34;base_url&#34;:&#34;https://identity.myvessel.top&#34;</span><span class=err>}}</span><span class=s>`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gh>matrix.myvessel.top</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>reverse_proxy</span> <span class=nd>/_matrix/*</span> <span class=n>localhost</span><span class=p>:</span><span class=mi>8008</span>
</span></span><span class=line><span class=cl><span class=k> </span> <span class=s> </span> <span class=s>reverse_proxy</span> <span class=nd>/_synapse/client/*</span> <span class=n>localhost</span><span class=p>:</span><span class=mi>8008</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可能有人会有疑惑这个 <code>identity.example.com</code> 没有配置过啊，是不是需要自己额外配置？答案是不需要，按照文档里写上就行了。</p><p>配置好反向代理之后按理来说就可以访问了，但我这里因为使用了 Delegation 功能，所以直接访问我的 server name 是看不到 Matrix 的相关信息的。所以使用 <a href=https://federationtester.matrix.org/ target=_blank>Matrix Federation Tester</a> 进行测试。在里面输入自己的 server name，若下方无报错并出现四个 Success 字样，即表示搭建成功，正常运行。接着就可以在各种客户端上使用了，可在 <a href=https://matrix.org/clients/ target=_blank>Clients | Matrix.org</a> 中寻找心仪的客户端。</p><div id=后记 class=anchor></div><h2 class="relative group">后记
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8e%e8%ae%b0 aria-label=锚点>#</a></span></h2><p>这也算是比较大的项目了，即使比起小白时有所长进，也还是磕磕绊绊踩了不少坑。顺便吐槽一下搭好之后用了不到一小时<a href=https://naine.cc target=_blank>
naine</a> 就觉得不好用，直接抛弃了<del>铁渣男</del>。所以撰写本文时服务器已经关闭了。但折腾过程还是挺有意思的，值得记录一下。</p><div id=参考文章 class=anchor></div><h2 class="relative group">参考文章
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0 aria-label=锚点>#</a></span></h2><p>除文中提及的官方文档外，参考文章如下：</p><ul><li><a href=https://east.moe/archives/1175 target=_blank>Matrix聊天服务器Synapse的搭建 - Fantasy Land</a></li><li><a href=https://yingziwu.gitlab.io/posts/matrix-deployment-process-part-1/ target=_blank>Matrix踩坑记（一） - 影子屋</a></li><li><a href=https://www.jianshu.com/p/5c445d8698a4 target=_blank>安装Matrix系统（Riot.im）的服务端Synapse - 简书</a></li></ul><p>感谢各位作者。</p></div></div><script>var oid="views_posts/搭建Matrix的服务端Synapse/index.md",oid_likes="likes_posts/搭建Matrix的服务端Synapse/index.md"</script><script type=text/javascript src=/js/page.min.0e49973b4ad0a382c7c6012d8bff8226316642daabc4f8a20477bd08674f3da6e2fa993bc20ad4f51e7c5bb68e6f913a207a7c4fe37ea0e7b806894afce0a64e.js integrity="sha512-DkmXO0rQo4LHxgEti/+CJjFmQtqrxPiiBHe9CGdPPabi+pk7wgrU9R58W7aOb5E6IHp8T+N+oOe4BolK/OCmTg=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/%E5%B0%86nginx%E6%9B%B4%E6%8D%A2%E4%B8%BAcaddy/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">将Nginx更换为Caddy</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2023-04-04 16:20:55 +0800 +0800">2023年 4月 4日</time></span></span></a></span>
<span><a class="flex text-right group ml-3" href=/posts/bang-dream-its-mygo-%E8%BF%BD%E7%95%AA%E8%AE%B0%E5%BD%95/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">BanG Dream! It's MyGO!!!!! 追番记录"</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2023-09-24 22:57:55 +0800 +0800">2023年 9月 24日</time></span></span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label title>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2023
Vessel</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a> 强力驱动</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.35c1113bcc16c5a59bf031082f9e63822aa95280423881a7847a7ff33a16e6299ce6a840d9ef4e10d947e030a18f3f20359afb2ec0f35967484b9a9360ac3145.js integrity="sha512-NcERO8wWxaWb8DEIL55jgiqpUoBCOIGnhHp/8zoW5imc5qhA2e9OENlH4DChjz8gNZr7LsDzWWdIS5qTYKwxRQ=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://b.myvessel.top/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title>
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>